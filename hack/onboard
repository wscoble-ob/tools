#!/bin/bash

if [ -d node_modules ]; then
    echo "This project is already onboarded. To onboard, run 'git clean -xdf' first."
    exit 0
fi

generate-env
docker volume rm bc_pg-data-15 || true
flox services start infra
yarn
while [ "$(docker compose ps postgresql --format json | jq '.Health')" != '"healthy"' ]; do
    echo "Waiting for postgresql to start..."
    sleep 1
done
yarn migrate
flox services start backend frontend
while [ "$(curl -s http://localhost:3000/api/status | jq '.status')" != '"ok"' ]; do
    echo "Waiting for api to start..."
    sleep 1
done
createuser
open http://localhost:3000
